<!DOCTYPE html>
<html lang="it">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Chiara Beauty Boutique - Prenotazioni</title>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Dancing+Script:wght@400;700&family=Poppins:wght@300;400;500;600&display=swap');
        
        :root {
            --primary-beige: #E5D2C1;
            --secondary-beige: #F5F0E8;
            --text-brown: #8B6F47;
            --accent-brown: #A0845C;
            --light-beige: #F9F6F1;
        }
        
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        
        body {
            font-family: 'Poppins', sans-serif;
            background: linear-gradient(135deg, var(--secondary-beige) 0%, var(--light-beige) 100%);
            color: var(--text-brown);
            line-height: 1.6;
            min-height: 100vh;
        }
        
        .container {
            max-width: 1200px;
            margin: 0 auto;
            padding: 20px;
        }
        
        .header {
            text-align: center;
            padding: 40px 0;
            background: var(--primary-beige);
            margin-bottom: 40px;
            border-radius: 20px;
            box-shadow: 0 10px 30px rgba(139, 111, 71, 0.1);
        }
        
        .logo {
            width: 120px;
            height: 120px;
            margin: 0 auto 20px;
            display: flex;
            align-items: center;
            justify-content: center;
            border-radius: 15px;
            overflow: hidden;
            box-shadow: 0 8px 25px rgba(139, 111, 71, 0.2);
        }
        
        .logo img {
            width: 100%;
            height: 100%;
            object-fit: cover;
        }
        
        .header h1 {
            font-family: 'Dancing Script', cursive;
            font-size: 3.8rem;
            font-weight: 700;
            margin-bottom: 15px;
            color: var(--text-brown);
            text-shadow: 2px 2px 4px rgba(139, 111, 71, 0.1);
        }
        
        .subtitle {
            font-size: 1.2rem;
            font-weight: 400;
            opacity: 0.85;
            margin-bottom: 10px;
            color: var(--accent-brown);
        }
        
        .address {
            margin-top: 15px;
            font-size: 1rem;
            font-weight: 400;
            background: rgba(255,255,255,0.3);
            padding: 10px 20px;
            border-radius: 25px;
            display: inline-block;
            text-decoration: none;
            color: var(--text-brown);
            transition: all 0.3s ease;
        }
        
        .address:hover {
            background: rgba(255,255,255,0.5);
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(139, 111, 71, 0.2);
        }
        
        .services-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(350px, 1fr));
            gap: 30px;
            margin-bottom: 50px;
        }
        
        .service-card {
            background: white;
            padding: 30px;
            border-radius: 20px;
            box-shadow: 0 15px 35px rgba(139, 111, 71, 0.1);
            transition: all 0.3s ease;
            border: 2px solid transparent;
            cursor: pointer;
        }
        
        .service-card:hover {
            transform: translateY(-5px);
            box-shadow: 0 20px 40px rgba(139, 111, 71, 0.15);
            border-color: var(--primary-beige);
        }
        
        .service-card.selected {
            border-color: var(--accent-brown);
            background: linear-gradient(135deg, var(--light-beige) 0%, white 100%);
        }
        
        .service-title {
            font-size: 1.5rem;
            font-weight: 600;
            margin-bottom: 15px;
            color: var(--accent-brown);
        }
        
        .service-description {
            font-size: 0.95rem;
            margin-bottom: 20px;
            opacity: 0.8;
            line-height: 1.5;
        }
        
        .service-details {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 15px;
            background: var(--light-beige);
            border-radius: 10px;
        }
        
        .price {
            font-size: 1.3rem;
            font-weight: 600;
            color: var(--accent-brown);
        }
        
        .duration {
            font-size: 0.9rem;
            opacity: 0.7;
        }
        
        .select-service-text {
            text-align: center;
            margin-top: 15px;
            font-size: 0.9rem;
            color: var(--accent-brown);
            font-weight: 500;
        }
        
        .booking-section {
            background: white;
            padding: 40px;
            border-radius: 20px;
            box-shadow: 0 15px 35px rgba(139, 111, 71, 0.1);
            margin-bottom: 50px;
        }
        
        .booking-title {
            font-size: 2rem;
            font-weight: 600;
            text-align: center;
            margin-bottom: 30px;
            color: var(--accent-brown);
        }
        
        .selected-service-info {
            background: var(--light-beige);
            padding: 20px;
            border-radius: 15px;
            margin-bottom: 30px;
            text-align: center;
            display: none;
        }
        
        .selected-service-info.show {
            display: block;
        }
        
        .selected-service-name {
            font-size: 1.3rem;
            font-weight: 600;
            color: var(--accent-brown);
            margin-bottom: 10px;
        }
        
        .selected-service-details {
            font-size: 1rem;
            opacity: 0.8;
        }
        
        .booking-form {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 20px;
            margin-bottom: 30px;
        }
        
        .form-group {
            display: flex;
            flex-direction: column;
        }
        
        .form-group.full-width {
            grid-column: 1 / -1;
        }
        
        label {
            font-size: 0.9rem;
            font-weight: 500;
            margin-bottom: 8px;
            color: var(--text-brown);
        }
        
        input, select {
            padding: 15px;
            border: 2px solid var(--primary-beige);
            border-radius: 10px;
            font-size: 1rem;
            background: white;
            color: var(--text-brown);
            transition: border-color 0.3s ease;
        }
        
        input:focus, select:focus {
            outline: none;
            border-color: var(--accent-brown);
        }
        
        .availability-indicator {
            font-size: 0.9rem;
            margin-top: 10px;
            padding: 10px 15px;
            border-radius: 15px;
            text-align: center;
            font-weight: 500;
        }
        
        .available {
            background: #d4edda;
            color: #155724;
        }
        
        .limited {
            background: #fff3cd;
            color: #856404;
        }
        
        .unavailable {
            background: #f8d7da;
            color: #721c24;
        }
        
        .book-btn {
            background: linear-gradient(135deg, var(--accent-brown) 0%, var(--text-brown) 100%);
            color: white;
            border: none;
            padding: 18px 40px;
            border-radius: 25px;
            font-size: 1.1rem;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s ease;
            width: 100%;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 15px;
        }
        
        .book-btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 10px 25px rgba(139, 111, 71, 0.3);
        }
        
        .book-btn:disabled {
            background: #ccc;
            cursor: not-allowed;
            transform: none;
            box-shadow: none;
        }
        
        .no-service-selected {
            text-align: center;
            padding: 40px;
            opacity: 0.6;
        }
        
        .nutritionist-section {
            background: white;
            padding: 40px;
            border-radius: 20px;
            box-shadow: 0 15px 35px rgba(139, 111, 71, 0.1);
            margin-top: 50px;
            text-align: center;
        }
        
        .nutritionist-title {
            font-size: 2rem;
            font-weight: 600;
            margin-bottom: 20px;
            color: var(--accent-brown);
        }
        
        .nutritionist-description {
            font-size: 1rem;
            line-height: 1.7;
            margin-bottom: 30px;
            opacity: 0.9;
        }
        
        .whatsapp-link {
            display: inline-flex;
            align-items: center;
            gap: 10px;
            background: #25D366;
            color: white;
            padding: 15px 30px;
            border-radius: 25px;
            text-decoration: none;
            font-weight: 600;
            transition: all 0.3s ease;
        }
        
        .whatsapp-link:hover {
            background: #20c157;
            transform: translateY(-2px);
            box-shadow: 0 10px 25px rgba(37, 211, 102, 0.3);
        }

        /* POPUP STYLES - DIMENSIONI RIDOTTE */
        .popup-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.7);
            backdrop-filter: blur(8px);
            display: flex;
            justify-content: center;
            align-items: center;
            z-index: 1000;
            opacity: 0;
            visibility: hidden;
            transition: all 0.3s ease;
        }

        .popup-overlay.show {
            opacity: 1;
            visibility: visible;
        }

        .popup-content {
            background: white;
            border-radius: 20px;
            padding: 30px 25px;
            max-width: 420px;
            width: 88%;
            text-align: center;
            position: relative;
            box-shadow: 0 20px 40px rgba(139, 111, 71, 0.3);
            transform: translateY(50px) scale(0.9);
            transition: all 0.3s ease;
        }

        .popup-overlay.show .popup-content {
            transform: translateY(0) scale(1);
        }

        .popup-close {
            position: absolute;
            top: 12px;
            right: 18px;
            background: none;
            border: none;
            font-size: 24px;
            color: var(--text-brown);
            cursor: pointer;
            opacity: 0.7;
            transition: opacity 0.3s ease;
        }

        .popup-close:hover {
            opacity: 1;
        }

        .popup-icon {
            font-size: 50px;
            margin-bottom: 15px;
            background: linear-gradient(135deg, var(--accent-brown), var(--text-brown));
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
        }

        .popup-title {
            font-size: 1.6rem;
            font-weight: 600;
            color: var(--accent-brown);
            margin-bottom: 15px;
            font-family: 'Dancing Script', cursive;
        }

        .popup-text {
            font-size: 0.95rem;
            color: var(--text-brown);
            line-height: 1.5;
            margin-bottom: 25px;
            opacity: 0.9;
        }

        .popup-buttons {
            display: flex;
            gap: 12px;
            justify-content: center;
            flex-wrap: wrap;
        }

        .popup-btn {
            padding: 12px 20px;
            border: none;
            border-radius: 20px;
            font-weight: 600;
            font-size: 0.9rem;
            cursor: pointer;
            transition: all 0.3s ease;
            text-decoration: none;
            display: inline-flex;
            align-items: center;
            gap: 8px;
        }

        .popup-btn.primary {
            background: linear-gradient(135deg, #25D366, #20c157);
            color: white;
        }

        .popup-btn.primary:hover {
            transform: translateY(-2px);
            box-shadow: 0 8px 20px rgba(37, 211, 102, 0.3);
        }

        .popup-btn.secondary {
            background: transparent;
            color: var(--text-brown);
            border: 2px solid var(--primary-beige);
        }

        .popup-btn.secondary:hover {
            background: var(--primary-beige);
            transform: translateY(-2px);
        }
        
        /* NUOVO STILE PER SEZIONE ORARI */
        .opening-hours-section {
            background: white;
            padding: 40px;
            border-radius: 20px;
            box-shadow: 0 15px 35px rgba(139, 111, 71, 0.1);
            margin-top: 50px;
            text-align: center;
        }

        .hours-title {
            font-size: 2rem;
            font-weight: 600;
            margin-bottom: 25px;
            color: var(--accent-brown);
        }

        .hours-content p {
            font-size: 1.1rem;
            line-height: 1.8;
            margin-bottom: 5px;
            color: var(--text-brown);
        }

        .hours-content hr {
            border: 0;
            height: 1px;
            background: var(--primary-beige);
            margin: 15px auto;
            width: 50%;
        }
        
        .header-links {
            display: flex;
            flex-direction: column;
            gap: 15px;
            align-items: center;
        }

        .instagram-link {
            margin-top: 10px;
            font-size: 1rem;
            font-weight: 400;
            background: linear-gradient(135deg, #E4405F, #C13584, #833AB4);
            color: white;
            padding: 10px 20px;
            border-radius: 25px;
            display: inline-flex;
            align-items: center;
            gap: 8px;
            text-decoration: none;
            transition: all 0.3s ease;
        }

        .instagram-link:hover {
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(196, 53, 132, 0.3);
        }

        @media (max-width: 768px) {
            .header-links {
                gap: 10px;
            }
            
            .header h1 {
                font-size: 2.8rem;
            }
            
            .logo {
                width: 100px;
                height: 100px;
            }
            
            .services-grid {
                grid-template-columns: 1fr;
            }
            
            .booking-form {
                grid-template-columns: 1fr;
            }
            
            .service-details {
                flex-direction: column;
                gap: 10px;
                text-align: center;
            }

            .popup-content {
                padding: 25px 18px;
                max-width: 95%;
            }

            .popup-buttons {
                flex-direction: column;
            }

            .popup-btn {
                width: 100%;
                justify-content: center;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <header class="header">
            <div class="logo">
                <img src="https://i.imgur.com/8idnEmB.jpg" alt="Chiara Beauty Boutique Logo">
            </div>
            <h1>Chiara Beauty Boutique</h1>
            <p class="subtitle">Centro di Estetica Avanzata</p>
            <a href="https://maps.app.goo.gl/giW8pZUkchSUi1hj6" target="_blank" class="address">📍 Via Roma 133, Nardò (Lecce)</a>
            <a href="https://www.instagram.com/chiara.beautyboutique?igsh=MXFieXZxamN6OXlsNQ==" target="_blank" class="instagram-link">
                <i class="fab fa-instagram"></i>
                @chiara.beautyboutique
            </a>
        </header>
        
        <div class="services-grid" id="servicesGrid">
            <!-- I servizi verranno generati dinamicamente -->
        </div>
        
        <section class="booking-section">
            <h2 class="booking-title">Prenota il tuo Trattamento</h2>
            
            <div class="selected-service-info" id="selectedServiceInfo">
                <div class="selected-service-name" id="selectedServiceName"></div>
                <div class="selected-service-details" id="selectedServiceDetails"></div>
            </div>
            
            <div class="no-service-selected" id="noServiceSelected">
                <p>👆 Seleziona prima un trattamento dall'elenco qui sopra</p>
            </div>
            
            <form class="booking-form" id="mainBookingForm" style="display: none;">
                <div class="form-group">
                    <label for="customerName">Nome *</label>
                    <input type="text" id="customerName" required>
                </div>
                <div class="form-group">
                    <label for="customerPhone">Telefono *</label>
                    <input type="tel" id="customerPhone" required>
                </div>
                <div class="form-group">
                    <label for="bookingDate">Data *</label>
                    <input type="date" id="bookingDate" required onchange="updateAvailability()">
                </div>
                <div class="form-group">
                    <label for="bookingTime">Orario *</label>
                    <select id="bookingTime" required onchange="updateAvailability()">
                        <option value="">Seleziona orario</option>
                    </select>
                </div>
                <div class="form-group full-width">
                    <div class="availability-indicator" id="availabilityIndicator"></div>
                </div>
            </form>
            
            <button class="book-btn" id="mainBookBtn" onclick="bookSelectedService()" style="display: none;">
                <i class="fab fa-whatsapp"></i>
                Prenota su WhatsApp
            </button>
        </section>
        
        <section class="nutritionist-section">
            <h2 class="nutritionist-title">Consulenza Nutrizionale</h2>
            <p class="nutritionist-description">
                Ciao, sono <strong>Matteo Minerba</strong>, <strong>biologo nutrizionista</strong> in collaborazione con il <strong>Centro Estetico Chiara Beauty Boutique</strong> per offrire un approccio integrato alla cura della persona, che unisce <strong>un'alimentazione sana ed equilibrata con trattamenti estetici professionali</strong>.
                Per i clienti del centro estetico sono previste <strong>offerte dedicate su percorsi nutrizionali personalizzati</strong>, studiati per <strong>potenziare i benefici dei trattamenti</strong> e supportare al meglio il raggiungimento dei risultati desiderati!<br>
                Per informazioni, è possibile prenotare una consulenza nutrizionale.
            </p>
            <a href="https://wa.me/393665068384?text=Ciao! Sono interessato/a a prenotare una consulenza nutrizionale. Potresti fornirmi maggiori informazioni?" class="whatsapp-link" target="_blank">
                <i class="fab fa-whatsapp"></i>
                Prenota Consulenza Nutrizionale!
            </a>
        </section>
        
        <section class="opening-hours-section">
            <h2 class="hours-title">I Nostri Orari</h2>
            <div class="hours-content">
                <p><strong>Martedì - Sabato</strong></p>
                <p>09:30 - 13:30</p>
                <p>16:00 - 20:00</p>
                <hr>
                <p><strong>Domenica & Lunedì</strong>: Chiuso</p>
            </div>
        </section>
    </div>
    
    <!-- POPUP CONSULENZA NUTRIZIONALE -->
    <div class="popup-overlay" id="nutritionistPopup">
        <div class="popup-content">
            <button class="popup-close" onclick="closeNutritionistPopup()">×</button>
            <div class="popup-icon">🍎</div>
            <h3 class="popup-title">Prenotazione confermata! Ora completa il tuo percorso di benessere!</h3>
            <p class="popup-text">
                Ciao, sono <strong>Matteo Minerba</strong>, <strong>sono un biologo nutrizionista</strong> e per rendere <strong>più efficaci e duraturi i trattamenti</strong>, ti invito ad intraprendere insieme una <strong>consulenza nutrizionale su misura per te</strong>.
                <br><br>
                <strong>Offerta speciale:</strong> Scopri come potenziare i benefici dei trattamenti estetici!
            </p>
            <div class="popup-buttons">
                <a href="#" onclick="acceptNutritionistOffer(event)" class="popup-btn primary">
                    <i class="fab fa-whatsapp"></i>
                    Sì, voglio saperne di più!
                </a>
                <button onclick="declineNutritionistOffer()" class="popup-btn secondary">
                    Magari più tardi...
                </button>
            </div>
        </div>
    </div>

    <!-- Vercel Web Analytics per siti HTML statici -->
    <script>
        window.va = window.va || function () { (window.vaq = window.vaq || []).push(arguments); };
    </script>
    <script defer src="/_vercel/insights/script.js"></script>

    <script>
        // Funzione helper per tracciare eventi personalizzati
        function trackEvent(eventName, properties = {}) {
            if (window.va) {
                window.va('track', eventName, properties);
            }
            // Backup: log in console per debug
            console.log('📊 Analytics Event:', eventName, properties);
        }

        // Configurazione servizi
        const services = [
            {
                id: 'antiage',
                title: 'Trattamento Anti-Age Avanzato',
                description: 'Trattamento rigenerante con tecnologie innovative per contrastare i segni del tempo. Combina radiofrequenza, ultrasuoni e sieri anti-age per un effetto lifting naturale.',
                price: 89,
                duration: 60,
                maxBookingsPerSlot: 3
            },
            {
                id: 'hydrafacial',
                title: 'HydraFacial MD',
                description: 'Il trattamento più rivoluzionario per la pulizia profonda del viso. Rimuove le impurità, esfolia delicatamente e idrata intensamente la pelle in un unico trattamento.',
                price: 120,
                duration: 45,
                maxBookingsPerSlot: 2
            },
            {
                id: 'microneedling',
                title: 'Microneedling con Sieri Attivi',
                description: 'Stimola il rinnovamento cellulare attraverso micro-perforazioni controllate. Ideale per cicatrici, rughe e texture della pelle. Include applicazione di sieri personalizzati.',
                price: 95,
                duration: 50,
                maxBookingsPerSlot: 3
            },
            {
                id: 'cryotherapy',
                title: 'Crioterapia Localizzata',
                description: 'Trattamento innovativo che utilizza il freddo controllato per tonificare, rassodare e rimodellare specifiche zone del corpo. Effetto immediato e duraturo.',
                price: 75,
                duration: 30,
                maxBookingsPerSlot: 4
            },
            {
                id: 'radiofrequenza',
                title: 'Radiofrequenza Corpo',
                description: 'Tecnologia avanzata per il rimodellamento corporeo e la riduzione della cellulite. Stimola la produzione di collagene per una pelle più tonica ed elastica.',
                price: 80,
                duration: 45,
                maxBookingsPerSlot: 3
            },
            {
                id: 'linfodrenaggio',
                title: 'Linfodrenaggio Pressoterapia',
                description: 'Massaggio meccanico che favorisce il drenaggio linfatico e la circolazione. Perfetto per ridurre gonfiori, ritenzione idrica e migliorare il tono della pelle.',
                price: 60,
                duration: 40,
                maxBookingsPerSlot: 3
            }
        ];

        // Numero WhatsApp del centro
        const WHATSAPP_NUMBER = '393513122638';
        
// ⚠️ URL del Google Apps Script
const GOOGLE_APPS_SCRIPT_URL = 'https://script.google.com/macros/s/AKfycbxVMzt3MpxxwcgyBrNmiYBAL5OPrUTRYXXc_2xLJPwVVQpKE6wXBSh8rg_qRQ5nL8Pd6g/exec';

// Cache e stato
let bookings = {};
let selectedService = null;
let lastCacheUpdate = null;
const CACHE_DURATION = 30000; // 30 secondi

// 🛡️ GESTIONE ERRORI EXTENSION CHROME
function setupErrorHandling() {
    // Gestisci errori delle estensioni Chrome
    window.addEventListener('error', function(e) {
        // Sopprimi errori comuni delle estensioni
        if (e.message.includes('Extension context invalidated') || 
            e.message.includes('message port closed') ||
            e.message.includes('runtime.lastError')) {
            console.log('🔇 Errore estensione Chrome soppresso:', e.message);
            e.preventDefault();
            return false;
        }
    });

    // Gestisci promise rejections non catturate
    window.addEventListener('unhandledrejection', function(e) {
        if (e.reason && typeof e.reason === 'string' && 
            (e.reason.includes('Extension') || e.reason.includes('runtime'))) {
            console.log('🔇 Promise rejection estensione Chrome soppressa:', e.reason);
            e.preventDefault();
        }
    });
}

// 🔧 FUNZIONE MIGLIORATA PER VERIFICARE DISPONIBILITÀ ONLINE
async function checkAvailabilityOnline(serviceId, date, time) {
    const controller = new AbortController();
    const timeoutId = setTimeout(() => controller.abort(), 10000); // 10s timeout

    try {
        console.log('🔍 Verifica disponibilità online...', { serviceId, date, time });
        
        const url = new URL(GOOGLE_APPS_SCRIPT_URL);
        url.searchParams.append('action', 'checkAvailability');
        url.searchParams.append('serviceId', serviceId);
        url.searchParams.append('date', date);
        url.searchParams.append('time', time);
        
        console.log('📡 URL chiamata:', url.toString());
        
        const response = await fetch(url, {
            method: 'GET',
            headers: {
                'Accept': 'application/json',
                'Cache-Control': 'no-cache'
            },
            signal: controller.signal
        });
        
        clearTimeout(timeoutId);
        
        console.log('📡 Response status:', response.status);
        
        if (!response.ok) {
            throw new Error(`HTTP ${response.status}: ${response.statusText}`);
        }
        
        const data = await response.json();
        console.log('✅ Risposta ricevuta:', data);
        
        if (data.success !== undefined) {
            return data.available || data.success;
        } else {
            throw new Error(data.error || 'Formato risposta non valido');
        }
        
    } catch (error) {
        clearTimeout(timeoutId);
        
        if (error.name === 'AbortError') {
            console.error('⏱️ Timeout verifica disponibilità online');
        } else {
            console.error('❌ Errore verifica disponibilità online:', error);
        }
        
        // Fallback alla verifica locale
        console.log('🔄 Fallback alla verifica locale...');
        return checkAvailabilityLocal(serviceId, date, time);
    }
}

// 🔧 FUNZIONE MIGLIORATA PER INVIARE PRENOTAZIONE
async function sendBookingToGoogleSheets(bookingData) {
    const controller = new AbortController();
    const timeoutId = setTimeout(() => controller.abort(), 15000); // 15s timeout

    try {
        console.log('📤 Invio prenotazione a Google Sheets...', bookingData);
        
        // Validazione dati
        const requiredFields = ['nome', 'telefono', 'servizio', 'data', 'orario'];
        for (const field of requiredFields) {
            if (!bookingData[field]) {
                throw new Error(`Campo obbligatorio mancante: ${field}`);
            }
        }
        
        const url = new URL(GOOGLE_APPS_SCRIPT_URL);
        url.searchParams.append('action', 'addBooking');
        url.searchParams.append('nome', bookingData.nome.trim());
        url.searchParams.append('telefono', bookingData.telefono.trim());
        url.searchParams.append('servizio', bookingData.servizio);
        url.searchParams.append('data', bookingData.data);
        url.searchParams.append('orario', bookingData.orario);
        url.searchParams.append('note', bookingData.note || '');
        url.searchParams.append('timestamp', new Date().toISOString());
        
        console.log('📡 URL prenotazione:', url.toString());
        
        const response = await fetch(url, {
            method: 'GET',
            headers: {
                'Accept': 'application/json',
                'Cache-Control': 'no-cache'
            },
            signal: controller.signal
        });
        
        clearTimeout(timeoutId);
        
        if (!response.ok) {
            throw new Error(`HTTP ${response.status}: ${response.statusText}`);
        }
        
        const data = await response.json();
        console.log('✅ Risposta prenotazione:', data);
        
        if (data.success) {
            return { success: true, message: data.message || 'Prenotazione inviata con successo!' };
        } else {
            throw new Error(data.error || 'Errore nell\'invio della prenotazione');
        }
        
    } catch (error) {
        clearTimeout(timeoutId);
        
        if (error.name === 'AbortError') {
            console.error('⏱️ Timeout invio prenotazione');
        } else {
            console.error('❌ Errore invio prenotazione:', error);
        }
        
        // Fallback al salvataggio locale
        console.log('🔄 Fallback al salvataggio locale...');
        saveBookingLocally(bookingData);
        
        return { 
            success: true, 
            message: 'Prenotazione salvata localmente. Ti contatteremo presto!',
            fallback: true
        };
    }
}

// 🔧 FUNZIONE MIGLIORATA PER VERIFICARE DISPONIBILITÀ GENERALE
async function checkAvailability(serviceId, date, time) {
    try {
        // Prima prova online
        const isAvailable = await checkAvailabilityOnline(serviceId, date, time);
        
        // Trova l'elemento per mostrare lo stato (con controllo sicurezza)
        const statusElement = document.querySelector('.availability-status');
        if (statusElement) {
            if (isAvailable) {
                statusElement.textContent = '✅ Disponibile';
                statusElement.className = 'availability-status available';
            } else {
                statusElement.textContent = '❌ Non disponibile';
                statusElement.className = 'availability-status unavailable';
            }
        }
        
        return isAvailable;
        
    } catch (error) {
        console.error('❌ Errore generale verifica disponibilità:', error);
        
        // In caso di errore, assume disponibile per non bloccare
        const statusElement = document.querySelector('.availability-status');
        if (statusElement) {
            statusElement.textContent = '⚠️ Verifica non riuscita - procedere con cautela';
            statusElement.className = 'availability-status warning';
        }
        
        return true; // Assume disponibile in caso di errore
    }
}

// VERIFICA LOCALE (FALLBACK) - MIGLIORATA
function checkAvailabilityLocal(serviceId, date, time) {
    try {
        const bookings = JSON.parse(localStorage.getItem('bookings') || '[]');
        const isBooked = bookings.some(booking => 
            booking.data === date && 
            booking.orario === time &&
            booking.serviceId === serviceId
        );
        
        console.log('💾 Verifica locale:', { serviceId, date, time, isBooked, totalBookings: bookings.length });
        return !isBooked;
    } catch (error) {
        console.error('❌ Errore verifica locale:', error);
        return true; // In caso di errore, assume disponibile
    }
}

// SALVATAGGIO LOCALE (FALLBACK) - MIGLIORATO
function saveBookingLocally(bookingData) {
    try {
        const bookings = JSON.parse(localStorage.getItem('bookings') || '[]');
        const newBooking = {
            ...bookingData,
            id: Date.now(),
            timestamp: new Date().toISOString(),
            status: 'pending',
            source: 'fallback'
        };
        
        bookings.push(newBooking);
        localStorage.setItem('bookings', JSON.stringify(bookings));
        
        console.log('💾 Prenotazione salvata localmente:', newBooking);
        
        // Notifica all'utente che la prenotazione è salvata localmente
        showNotification('Prenotazione salvata localmente. Ti contatteremo per confermare.', 'info');
        
    } catch (error) {
        console.error('❌ Errore salvataggio locale:', error);
        showNotification('Errore nel salvataggio. Riprova o contattaci direttamente.', 'error');
    }
}

// 🔧 FUNZIONE MIGLIORATA DI TEST CONNESSIONE
async function testConnection() {
    const controller = new AbortController();
    const timeoutId = setTimeout(() => controller.abort(), 8000); // 8s timeout
    
    try {
        console.log('🧪 Test connessione Google Apps Script...');
        
        const url = new URL(GOOGLE_APPS_SCRIPT_URL);
        url.searchParams.append('action', 'test');
        url.searchParams.append('timestamp', Date.now());
        
        const response = await fetch(url, {
            method: 'GET',
            headers: {
                'Accept': 'application/json',
                'Cache-Control': 'no-cache'
            },
            signal: controller.signal
        });
        
        clearTimeout(timeoutId);
        
        if (!response.ok) {
            throw new Error(`HTTP ${response.status}`);
        }
        
        const data = await response.json();
        console.log('✅ Test connessione riuscito:', data);
        
        showNotification('Connessione al server attiva', 'success');
        return true;
        
    } catch (error) {
        clearTimeout(timeoutId);
        
        if (error.name === 'AbortError') {
            console.error('⏱️ Timeout test connessione');
        } else {
            console.error('❌ Test connessione fallito:', error);
        }
        
        showNotification('Connessione al server non disponibile - modalità offline attiva', 'warning');
        return false;
    }
}

// 🆕 FUNZIONE PER MOSTRARE NOTIFICHE
function showNotification(message, type = 'info') {
    // Rimuovi notifiche esistenti
    const existingNotifications = document.querySelectorAll('.notification');
    existingNotifications.forEach(n => n.remove());
    
    // Crea nuova notifica
    const notification = document.createElement('div');
    notification.className = `notification notification-${type}`;
    notification.style.cssText = `
        position: fixed;
        top: 20px;
        right: 20px;
        padding: 15px 20px;
        border-radius: 8px;
        z-index: 10000;
        font-weight: 500;
        box-shadow: 0 4px 12px rgba(0,0,0,0.15);
        transform: translateX(100%);
        transition: transform 0.3s ease;
    `;
    
    // Colori in base al tipo
    const colors = {
        success: { bg: '#d4edda', color: '#155724', border: '#c3e6cb' },
        error: { bg: '#f8d7da', color: '#721c24', border: '#f5c6cb' },
        warning: { bg: '#fff3cd', color: '#856404', border: '#ffeaa7' },
        info: { bg: '#d1ecf1', color: '#0c5460', border: '#bee5eb' }
    };
    
    const style = colors[type] || colors.info;
    notification.style.backgroundColor = style.bg;
    notification.style.color = style.color;
    notification.style.border = `1px solid ${style.border}`;
    
    notification.textContent = message;
    document.body.appendChild(notification);
    
    // Animazione di entrata
    setTimeout(() => {
        notification.style.transform = 'translateX(0)';
    }, 100);
    
    // Rimozione automatica
    setTimeout(() => {
        notification.style.transform = 'translateX(100%)';
        setTimeout(() => notification.remove(), 300);
    }, 5000);
}

// Carica prenotazioni da Google Sheets - MIGLIORATA
async function loadBookingsFromGoogle() {
    const controller = new AbortController();
    const timeoutId = setTimeout(() => controller.abort(), 12000); // 12s timeout
    
    try {
        console.log('🔄 Caricamento prenotazioni da Google Sheets...');
        
        const url = new URL(GOOGLE_APPS_SCRIPT_URL);
        url.searchParams.append('action', 'getBookings');
        url.searchParams.append('timestamp', Date.now());
        
        const response = await fetch(url, {
            method: 'GET',
            headers: {
                'Accept': 'application/json',
                'Cache-Control': 'no-cache'
            },
            signal: controller.signal
        });
        
        clearTimeout(timeoutId);
        
        if (!response.ok) {
            throw new Error(`HTTP ${response.status}: ${response.statusText}`);
        }
        
        const result = await response.json();
        
        if (result.success) {
            bookings = result.data?.bookings || {};
            lastCacheUpdate = Date.now();
            console.log('✅ Prenotazioni caricate da Google Sheets:', Object.keys(bookings).length);
            return true;
        } else {
            throw new Error(result.message || 'Risposta non valida dal server');
        }
        
    } catch (error) {
        clearTimeout(timeoutId);
        
        if (error.name === 'AbortError') {
            console.error('⏱️ Timeout caricamento prenotazioni');
        } else {
            console.error('❌ Errore caricamento da Google Sheets:', error);
        }
        
        // Fallback: carica dati locali
        console.log('📦 Fallback: utilizzo dati locali');
        try {
            const localBookings = JSON.parse(localStorage.getItem('bookings') || '[]');
            bookings = {};
            // Converte array locale in formato hash
            localBookings.forEach(booking => {
                const key = `${booking.serviceId}-${booking.data}-${booking.orario}`;
                bookings[key] = (bookings[key] || 0) + 1;
            });
            console.log('📦 Dati locali caricati:', Object.keys(bookings).length);
        } catch (localError) {
            console.error('❌ Errore caricamento dati locali:', localError);
            bookings = {};
        }
        
        return false;
    }
}

// FUNZIONE DI SUPPORTO per generare chiave prenotazione
function getBookingKey(serviceId, date, time) {
    return `${serviceId}-${date}-${time}`;
}

// Funzione per selezionare un servizio - MIGLIORATA
function selectService(serviceId) {
    try {
        // Rimuovi selezione precedente
        document.querySelectorAll('.service-card').forEach(card => {
            card.classList.remove('selected');
        });
        
        // Seleziona nuovo servizio
        const selectedCard = document.querySelector(`[data-service-id="${serviceId}"]`);
        if (!selectedCard) {
            console.error('❌ Servizio non trovato:', serviceId);
            return;
        }
        
        selectedCard.classList.add('selected');
        
        // Trova il servizio nei dati
        selectedService = window.services?.find(s => s.id === serviceId);
        if (!selectedService) {
            console.error('❌ Dati servizio non trovati:', serviceId);
            return;
        }
        
        // 📊 TRACCIA SELEZIONE SERVIZIO (se trackEvent è disponibile)
        if (typeof trackEvent === 'function') {
            trackEvent('Service Selected', {
                service_id: selectedService.id,
                service_name: selectedService.title,
                price: selectedService.price,
                duration: selectedService.duration
            });
        }
        
        // Aggiorna UI con controlli di sicurezza
        const serviceNameEl = document.getElementById('selectedServiceName');
        const serviceDetailsEl = document.getElementById('selectedServiceDetails');
        const serviceInfoEl = document.getElementById('selectedServiceInfo');
        const noServiceEl = document.getElementById('noServiceSelected');
        const formEl = document.getElementById('mainBookingForm');
        const btnEl = document.getElementById('mainBookBtn');
        
        if (serviceNameEl) serviceNameEl.textContent = selectedService.title;
        if (serviceDetailsEl) serviceDetailsEl.textContent = `€${selectedService.price} • ${selectedService.duration} minuti`;
        if (serviceInfoEl) serviceInfoEl.classList.add('show');
        if (noServiceEl) noServiceEl.style.display = 'none';
        if (formEl) formEl.style.display = 'grid';
        if (btnEl) btnEl.style.display = 'flex';
        
        // Reset form e disponibilità
        if (formEl) formEl.reset();
        const availabilityEl = document.getElementById('availabilityIndicator');
        if (availabilityEl) {
            availabilityEl.textContent = '';
            availabilityEl.className = 'availability-indicator';
        }
        
        console.log('✅ Servizio selezionato:', selectedService.title);
        
    } catch (error) {
        console.error('❌ Errore selezione servizio:', error);
        showNotification('Errore nella selezione del servizio', 'error');
    }
}

// Rest of your existing functions would continue here...
// (I've shown the key improvements for the main functions that handle network requests and error handling)

// Inizializzazione della pagina - MIGLIORATA
document.addEventListener('DOMContentLoaded', async function() {
    try {
        // Configura gestione errori per le estensioni Chrome
        setupErrorHandling();
        
        console.log('🚀 Inizializzazione sistema prenotazioni...');
        
        // Test di connessione iniziale
        const isConnected = await testConnection();
        
        // Carica prenotazioni (con fallback)
        await loadBookingsFromGoogle();
        
        // Inizializza UI
        if (typeof generateServiceCards === 'function') generateServiceCards();
        if (typeof populateTimeSlots === 'function') populateTimeSlots();
        
        const dateInput = document.getElementById('bookingDate');
        if (dateInput && typeof getMinDate === 'function') {
            dateInput.min = getMinDate();
        }

        // 📊 TRACCIA VISITA PAGINA (se trackEvent è disponibile)
        if (typeof trackEvent === 'function') {
            trackEvent('Page View', {
                page: 'booking',
                timestamp: new Date().toISOString(),
                existing_bookings: Object.keys(bookings).length,
                connection_status: isConnected ? 'online' : 'offline'
            });
        }
        
        // Event listeners per link esterni
        setupExternalLinkTracking();
        
        console.log('✅ Inizializzazione completata');
        showNotification('Sistema prenotazioni caricato', 'success');
        
    } catch (error) {
        console.error('❌ Errore inizializzazione:', error);
        showNotification('Errore durante il caricamento. Alcune funzioni potrebbero non essere disponibili.', 'error');
    }
});

// 📊 SETUP TRACKING LINK ESTERNI
function setupExternalLinkTracking() {
    if (typeof trackEvent !== 'function') return;
    
    document.addEventListener('click', function(e) {
        try {
            const instagramLink = e.target.closest('a[href*="instagram.com"]');
            if (instagramLink) {
                trackEvent('External Link Click', {
                    link_type: 'instagram',
                    url: instagramLink.href
                });
            }
            
            const mapLink = e.target.closest('a[href*="maps.app.goo.gl"]');
            if (mapLink) {
                trackEvent('External Link Click', {
                    link_type: 'google_maps',
                    url: mapLink.href
                });
            }
            
            const nutritionistLink = e.target.closest('a[href*="wa.me/393665068384"]');
            if (nutritionistLink) {
                trackEvent('Nutritionist Contact', {
                    source: 'main_section',
                    contact_method: 'whatsapp'
                });
            }
        } catch (error) {
            console.error('❌ Errore tracking link:', error);
        }
    });
}
        
</body>
</html>
