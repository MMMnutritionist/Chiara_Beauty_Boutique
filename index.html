<!DOCTYPE html>
<html lang="it">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Chiara Beauty Boutique - Prenotazioni</title>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Dancing+Script:wght@400;700&family=Poppins:wght@300;400;500;600&display=swap');
        
        :root {
            --primary-beige: #E5D2C1;
            --secondary-beige: #F5F0E8;
            --text-brown: #8B6F47;
            --accent-brown: #A0845C;
            --light-beige: #F9F6F1;
        }
        
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        
        body {
            font-family: 'Poppins', sans-serif;
            background: linear-gradient(135deg, var(--secondary-beige) 0%, var(--light-beige) 100%);
            color: var(--text-brown);
            line-height: 1.6;
            min-height: 100vh;
        }
        
        .container {
            max-width: 1200px;
            margin: 0 auto;
            padding: 20px;
        }
        
        .header {
            text-align: center;
            padding: 40px 0;
            background: var(--primary-beige);
            margin-bottom: 40px;
            border-radius: 20px;
            box-shadow: 0 10px 30px rgba(139, 111, 71, 0.1);
        }
        
        .logo {
            width: 120px;
            height: 120px;
            margin: 0 auto 20px;
            display: flex;
            align-items: center;
            justify-content: center;
            border-radius: 15px;
            overflow: hidden;
            box-shadow: 0 8px 25px rgba(139, 111, 71, 0.2);
        }
        
        .logo img {
            width: 100%;
            height: 100%;
            object-fit: cover;
        }
        
        .header h1 {
            font-family: 'Dancing Script', cursive;
            font-size: 3.8rem;
            font-weight: 700;
            margin-bottom: 15px;
            color: var(--text-brown);
            text-shadow: 2px 2px 4px rgba(139, 111, 71, 0.1);
        }
        
        .subtitle {
            font-size: 1.2rem;
            font-weight: 400;
            opacity: 0.85;
            margin-bottom: 10px;
            color: var(--accent-brown);
        }
        
        .address {
            margin-top: 15px;
            font-size: 1rem;
            font-weight: 400;
            background: rgba(255,255,255,0.3);
            padding: 10px 20px;
            border-radius: 25px;
            display: inline-block;
            text-decoration: none;
            color: var(--text-brown);
            transition: all 0.3s ease;
        }
        
        .address:hover {
            background: rgba(255,255,255,0.5);
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(139, 111, 71, 0.2);
        }
        
        .services-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(350px, 1fr));
            gap: 30px;
            margin-bottom: 50px;
        }
        
        .service-card {
            background: white;
            padding: 30px;
            border-radius: 20px;
            box-shadow: 0 15px 35px rgba(139, 111, 71, 0.1);
            transition: all 0.3s ease;
            border: 2px solid transparent;
            cursor: pointer;
        }
        
        .service-card:hover {
            transform: translateY(-5px);
            box-shadow: 0 20px 40px rgba(139, 111, 71, 0.15);
            border-color: var(--primary-beige);
        }
        
        .service-card.selected {
            border-color: var(--accent-brown);
            background: linear-gradient(135deg, var(--light-beige) 0%, white 100%);
        }
        
        .service-title {
            font-size: 1.5rem;
            font-weight: 600;
            margin-bottom: 15px;
            color: var(--accent-brown);
        }
        
        .service-description {
            font-size: 0.95rem;
            margin-bottom: 20px;
            opacity: 0.8;
            line-height: 1.5;
        }
        
        .service-details {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 15px;
            background: var(--light-beige);
            border-radius: 10px;
        }
        
        .price {
            font-size: 1.3rem;
            font-weight: 600;
            color: var(--accent-brown);
        }
        
        .duration {
            font-size: 0.9rem;
            opacity: 0.7;
        }
        
        .select-service-text {
            text-align: center;
            margin-top: 15px;
            font-size: 0.9rem;
            color: var(--accent-brown);
            font-weight: 500;
        }
        
        .booking-section {
            background: white;
            padding: 40px;
            border-radius: 20px;
            box-shadow: 0 15px 35px rgba(139, 111, 71, 0.1);
            margin-bottom: 50px;
        }
        
        .booking-title {
            font-size: 2rem;
            font-weight: 600;
            text-align: center;
            margin-bottom: 30px;
            color: var(--accent-brown);
        }
        
        .selected-service-info {
            background: var(--light-beige);
            padding: 20px;
            border-radius: 15px;
            margin-bottom: 30px;
            text-align: center;
            display: none;
        }
        
        .selected-service-info.show {
            display: block;
        }
        
        .selected-service-name {
            font-size: 1.3rem;
            font-weight: 600;
            color: var(--accent-brown);
            margin-bottom: 10px;
        }
        
        .selected-service-details {
            font-size: 1rem;
            opacity: 0.8;
        }
        
        .booking-form {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 20px;
            margin-bottom: 30px;
        }
        
        .form-group {
            display: flex;
            flex-direction: column;
        }
        
        .form-group.full-width {
            grid-column: 1 / -1;
        }
        
        label {
            font-size: 0.9rem;
            font-weight: 500;
            margin-bottom: 8px;
            color: var(--text-brown);
        }
        
        input, select {
            padding: 15px;
            border: 2px solid var(--primary-beige);
            border-radius: 10px;
            font-size: 1rem;
            background: white;
            color: var(--text-brown);
            transition: border-color 0.3s ease;
        }
        
        input:focus, select:focus {
            outline: none;
            border-color: var(--accent-brown);
        }
        
        .availability-indicator {
            font-size: 0.9rem;
            margin-top: 10px;
            padding: 10px 15px;
            border-radius: 15px;
            text-align: center;
            font-weight: 500;
        }
        
        .available {
            background: #d4edda;
            color: #155724;
        }
        
        .limited {
            background: #fff3cd;
            color: #856404;
        }
        
        .unavailable {
            background: #f8d7da;
            color: #721c24;
        }
        
        .book-btn {
            background: linear-gradient(135deg, var(--accent-brown) 0%, var(--text-brown) 100%);
            color: white;
            border: none;
            padding: 18px 40px;
            border-radius: 25px;
            font-size: 1.1rem;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s ease;
            width: 100%;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 15px;
        }
        
        .book-btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 10px 25px rgba(139, 111, 71, 0.3);
        }
        
        .book-btn:disabled {
            background: #ccc;
            cursor: not-allowed;
            transform: none;
            box-shadow: none;
        }
        
        .no-service-selected {
            text-align: center;
            padding: 40px;
            opacity: 0.6;
        }
        
        .nutritionist-section {
            background: white;
            padding: 40px;
            border-radius: 20px;
            box-shadow: 0 15px 35px rgba(139, 111, 71, 0.1);
            margin-top: 50px;
            text-align: center;
        }
        
        .nutritionist-title {
            font-size: 2rem;
            font-weight: 600;
            margin-bottom: 20px;
            color: var(--accent-brown);
        }
        
        .nutritionist-description {
            font-size: 1rem;
            line-height: 1.7;
            margin-bottom: 30px;
            opacity: 0.9;
        }
        
        .whatsapp-link {
            display: inline-flex;
            align-items: center;
            gap: 10px;
            background: #25D366;
            color: white;
            padding: 15px 30px;
            border-radius: 25px;
            text-decoration: none;
            font-weight: 600;
            transition: all 0.3s ease;
        }
        
        .whatsapp-link:hover {
            background: #20c157;
            transform: translateY(-2px);
            box-shadow: 0 10px 25px rgba(37, 211, 102, 0.3);
        }

        /* POPUP STYLES - DIMENSIONI RIDOTTE */
        .popup-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.7);
            backdrop-filter: blur(8px);
            display: flex;
            justify-content: center;
            align-items: center;
            z-index: 1000;
            opacity: 0;
            visibility: hidden;
            transition: all 0.3s ease;
        }

        .popup-overlay.show {
            opacity: 1;
            visibility: visible;
        }

        .popup-content {
            background: white;
            border-radius: 20px;
            padding: 30px 25px;
            max-width: 420px;
            width: 88%;
            text-align: center;
            position: relative;
            box-shadow: 0 20px 40px rgba(139, 111, 71, 0.3);
            transform: translateY(50px) scale(0.9);
            transition: all 0.3s ease;
        }

        .popup-overlay.show .popup-content {
            transform: translateY(0) scale(1);
        }

        .popup-close {
            position: absolute;
            top: 12px;
            right: 18px;
            background: none;
            border: none;
            font-size: 24px;
            color: var(--text-brown);
            cursor: pointer;
            opacity: 0.7;
            transition: opacity 0.3s ease;
        }

        .popup-close:hover {
            opacity: 1;
        }

        .popup-icon {
            font-size: 50px;
            margin-bottom: 15px;
            background: linear-gradient(135deg, var(--accent-brown), var(--text-brown));
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
        }

        .popup-title {
            font-size: 1.6rem;
            font-weight: 600;
            color: var(--accent-brown);
            margin-bottom: 15px;
            font-family: 'Dancing Script', cursive;
        }

        .popup-text {
            font-size: 0.95rem;
            color: var(--text-brown);
            line-height: 1.5;
            margin-bottom: 25px;
            opacity: 0.9;
        }

        .popup-buttons {
            display: flex;
            gap: 12px;
            justify-content: center;
            flex-wrap: wrap;
        }

        .popup-btn {
            padding: 12px 20px;
            border: none;
            border-radius: 20px;
            font-weight: 600;
            font-size: 0.9rem;
            cursor: pointer;
            transition: all 0.3s ease;
            text-decoration: none;
            display: inline-flex;
            align-items: center;
            gap: 8px;
        }

        .popup-btn.primary {
            background: linear-gradient(135deg, #25D366, #20c157);
            color: white;
        }

        .popup-btn.primary:hover {
            transform: translateY(-2px);
            box-shadow: 0 8px 20px rgba(37, 211, 102, 0.3);
        }

        .popup-btn.secondary {
            background: transparent;
            color: var(--text-brown);
            border: 2px solid var(--primary-beige);
        }

        .popup-btn.secondary:hover {
            background: var(--primary-beige);
            transform: translateY(-2px);
        }
        
        /* NUOVO STILE PER SEZIONE ORARI */
        .opening-hours-section {
            background: white;
            padding: 40px;
            border-radius: 20px;
            box-shadow: 0 15px 35px rgba(139, 111, 71, 0.1);
            margin-top: 50px;
            text-align: center;
        }

        .hours-title {
            font-size: 2rem;
            font-weight: 600;
            margin-bottom: 25px;
            color: var(--accent-brown);
        }

        .hours-content p {
            font-size: 1.1rem;
            line-height: 1.8;
            margin-bottom: 5px;
            color: var(--text-brown);
        }

        .hours-content hr {
            border: 0;
            height: 1px;
            background: var(--primary-beige);
            margin: 15px auto;
            width: 50%;
        }
        
        .header-links {
            display: flex;
            flex-direction: column;
            gap: 15px;
            align-items: center;
        }

        .instagram-link {
            margin-top: 10px;
            font-size: 1rem;
            font-weight: 400;
            background: linear-gradient(135deg, #E4405F, #C13584, #833AB4);
            color: white;
            padding: 10px 20px;
            border-radius: 25px;
            display: inline-flex;
            align-items: center;
            gap: 8px;
            text-decoration: none;
            transition: all 0.3s ease;
        }

        .instagram-link:hover {
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(196, 53, 132, 0.3);
        }

        @media (max-width: 768px) {
            .header-links {
                gap: 10px;
            }
            
            .header h1 {
                font-size: 2.8rem;
            }
            
            .logo {
                width: 100px;
                height: 100px;
            }
            
            .services-grid {
                grid-template-columns: 1fr;
            }
            
            .booking-form {
                grid-template-columns: 1fr;
            }
            
            .service-details {
                flex-direction: column;
                gap: 10px;
                text-align: center;
            }

            .popup-content {
                padding: 25px 18px;
                max-width: 95%;
            }

            .popup-buttons {
                flex-direction: column;
            }

            .popup-btn {
                width: 100%;
                justify-content: center;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <header class="header">
            <div class="logo">
                <img src="https://i.imgur.com/8idnEmB.jpg" alt="Chiara Beauty Boutique Logo">
            </div>
            <h1>Chiara Beauty Boutique</h1>
            <p class="subtitle">Centro di Estetica Avanzata</p>
            <a href="https://maps.app.goo.gl/giW8pZUkchSUi1hj6" target="_blank" class="address">📍 Via Roma 133, Nardò (Lecce)</a>
            <a href="https://www.instagram.com/chiara.beautyboutique?igsh=MXFieXZxamN6OXlsNQ==" target="_blank" class="instagram-link">
                <i class="fab fa-instagram"></i>
                @chiara.beautyboutique
            </a>
        </header>
        
        <div class="services-grid" id="servicesGrid">
            <!-- I servizi verranno generati dinamicamente -->
        </div>
        
        <section class="booking-section">
            <h2 class="booking-title">Prenota il tuo Trattamento</h2>
            
            <div class="selected-service-info" id="selectedServiceInfo">
                <div class="selected-service-name" id="selectedServiceName"></div>
                <div class="selected-service-details" id="selectedServiceDetails"></div>
            </div>
            
            <div class="no-service-selected" id="noServiceSelected">
                <p>👆 Seleziona prima un trattamento dall'elenco qui sopra</p>
            </div>
            
            <form class="booking-form" id="mainBookingForm" style="display: none;">
                <div class="form-group">
                    <label for="customerName">Nome *</label>
                    <input type="text" id="customerName" required>
                </div>
                <div class="form-group">
                    <label for="customerPhone">Telefono *</label>
                    <input type="tel" id="customerPhone" required>
                </div>
                <div class="form-group">
                    <label for="bookingDate">Data *</label>
                    <input type="date" id="bookingDate" required onchange="updateAvailability()">
                </div>
                <div class="form-group">
                    <label for="bookingTime">Orario *</label>
                    <select id="bookingTime" required onchange="updateAvailability()">
                        <option value="">Seleziona orario</option>
                    </select>
                </div>
                <div class="form-group full-width">
                    <div class="availability-indicator" id="availabilityIndicator"></div>
                </div>
            </form>
            
            <button class="book-btn" id="mainBookBtn" onclick="bookSelectedService()" style="display: none;">
                <i class="fab fa-whatsapp"></i>
                Prenota su WhatsApp
            </button>
        </section>
        
        <section class="nutritionist-section">
            <h2 class="nutritionist-title">Consulenza Nutrizionale</h2>
            <p class="nutritionist-description">
                Ciao, sono <strong>Matteo Minerba</strong>, <strong>biologo nutrizionista</strong> in collaborazione con il <strong>Centro Estetico Chiara Beauty Boutique</strong> per offrire un approccio integrato alla cura della persona, che unisce <strong>un'alimentazione sana ed equilibrata con trattamenti estetici professionali</strong>.
                Per i clienti del centro estetico sono previste <strong>offerte dedicate su percorsi nutrizionali personalizzati</strong>, studiati per <strong>potenziare i benefici dei trattamenti</strong> e supportare al meglio il raggiungimento dei risultati desiderati!<br>
                Per informazioni, è possibile prenotare una consulenza nutrizionale.
            </p>
            <a href="https://wa.me/393665068384?text=Ciao! Sono interessato/a a prenotare una consulenza nutrizionale. Potresti fornirmi maggiori informazioni?" class="whatsapp-link" target="_blank">
                <i class="fab fa-whatsapp"></i>
                Prenota Consulenza Nutrizionale!
            </a>
        </section>
        
        <section class="opening-hours-section">
            <h2 class="hours-title">I Nostri Orari</h2>
            <div class="hours-content">
                <p><strong>Martedì - Sabato</strong></p>
                <p>09:30 - 13:30</p>
                <p>16:00 - 20:00</p>
                <hr>
                <p><strong>Domenica & Lunedì</strong>: Chiuso</p>
            </div>
        </section>
    </div>
    
    <!-- POPUP CONSULENZA NUTRIZIONALE -->
    <div class="popup-overlay" id="nutritionistPopup">
        <div class="popup-content">
            <button class="popup-close" onclick="closeNutritionistPopup()">×</button>
            <div class="popup-icon">🍎</div>
            <h3 class="popup-title">Prenotazione confermata! Ora completa il tuo percorso di benessere!</h3>
            <p class="popup-text">
                Ciao, sono <strong>Matteo Minerba</strong>, <strong>sono un biologo nutrizionista</strong> e per rendere <strong>più efficaci e duraturi i trattamenti</strong>, ti invito ad intraprendere insieme una <strong>consulenza nutrizionale su misura per te</strong>.
                <br><br>
                <strong>Offerta speciale:</strong> Scopri come potenziare i benefici dei trattamenti estetici!
            </p>
            <div class="popup-buttons">
                <a href="#" onclick="acceptNutritionistOffer(event)" class="popup-btn primary">
                    <i class="fab fa-whatsapp"></i>
                    Sì, voglio saperne di più!
                </a>
                <button onclick="declineNutritionistOffer()" class="popup-btn secondary">
                    Magari più tardi...
                </button>
            </div>
        </div>
    </div>

    <!-- Vercel Web Analytics per siti HTML statici -->
    <script>
        window.va = window.va || function () { (window.vaq = window.vaq || []).push(arguments); };
    </script>
    <script defer src="/_vercel/insights/script.js"></script>

    <script>
        // Funzione helper per tracciare eventi personalizzati
        function trackEvent(eventName, properties = {}) {
            if (window.va) {
                window.va('track', eventName, properties);
            }
            // Backup: log in console per debug
            console.log('📊 Analytics Event:', eventName, properties);
        }

        // Configurazione servizi
        const services = [
            {
                id: 'antiage',
                title: 'Trattamento Anti-Age Avanzato',
                description: 'Trattamento rigenerante con tecnologie innovative per contrastare i segni del tempo. Combina radiofrequenza, ultrasuoni e sieri anti-age per un effetto lifting naturale.',
                price: 89,
                duration: 60,
                maxBookingsPerSlot: 3
            },
            {
                id: 'hydrafacial',
                title: 'HydraFacial MD',
                description: 'Il trattamento più rivoluzionario per la pulizia profonda del viso. Rimuove le impurità, esfolia delicatamente e idrata intensamente la pelle in un unico trattamento.',
                price: 120,
                duration: 45,
                maxBookingsPerSlot: 2
            },
            {
                id: 'microneedling',
                title: 'Microneedling con Sieri Attivi',
                description: 'Stimola il rinnovamento cellulare attraverso micro-perforazioni controllate. Ideale per cicatrici, rughe e texture della pelle. Include applicazione di sieri personalizzati.',
                price: 95,
                duration: 50,
                maxBookingsPerSlot: 3
            },
            {
                id: 'cryotherapy',
                title: 'Crioterapia Localizzata',
                description: 'Trattamento innovativo che utilizza il freddo controllato per tonificare, rassodare e rimodellare specifiche zone del corpo. Effetto immediato e duraturo.',
                price: 75,
                duration: 30,
                maxBookingsPerSlot: 4
            },
            {
                id: 'radiofrequenza',
                title: 'Radiofrequenza Corpo',
                description: 'Tecnologia avanzata per il rimodellamento corporeo e la riduzione della cellulite. Stimola la produzione di collagene per una pelle più tonica ed elastica.',
                price: 80,
                duration: 45,
                maxBookingsPerSlot: 3
            },
            {
                id: 'linfodrenaggio',
                title: 'Linfodrenaggio Pressoterapia',
                description: 'Massaggio meccanico che favorisce il drenaggio linfatico e la circolazione. Perfetto per ridurre gonfiori, ritenzione idrica e migliorare il tono della pelle.',
                price: 60,
                duration: 40,
                maxBookingsPerSlot: 3
            }
        ];

        // Numero WhatsApp del centro
        const WHATSAPP_NUMBER = '393513122638';

        // CONFIGURAZIONE GOOGLE APPS SCRIPT
        const GOOGLE_APPS_SCRIPT_URL = 'https://script.google.com/macros/s/AKfycbzdYCjKXmPT4XwD3tIXZ7PaAsRsKxKVcJRU3GquO1auIXAx6LZZOCON0nDdAHUDt8_cYA/exec';

        // Cache e stato
        let bookings = {};
        let selectedService = null;
        let lastCacheUpdate = null;
        const CACHE_DURATION = 30000; // 30 secondi

        // Carica prenotazioni da Google Sheets
        async function loadBookingsFromGoogle() {
            try {
                console.log('🔄 Caricamento prenotazioni da Google Sheets...');
                
                const response = await fetch(`${GOOGLE_APPS_SCRIPT_URL}?action=getBookings`);
                const result = await response.json();
                
                if (result.success) {
                    bookings = result.data.bookings || {};
                    lastCacheUpdate = Date.now();
                    console.log('✅ Prenotazioni caricate da Google Sheets:', Object.keys(bookings).length);
                    return true;
                } else {
                    throw new Error(result.message);
                }
            } catch (error) {
                console.error('❌ Errore caricamento da Google Sheets:', error);
                
                // Fallback: carica da variabile
                console.log('📦 Fallback: utilizzo dati locali');
                bookings = {};
                return false;
            }
        }

        // Salva prenotazione su Google Sheets
        async function saveBookingToGoogle(bookingData) {
            try {
                console.log('💾 Salvataggio prenotazione su Google Sheets...');
                
                const response = await fetch(GOOGLE_APPS_SCRIPT_URL, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify(bookingData)
                });
                
                const result = await response.json();
                
                if (result.success) {
                    console.log('✅ Prenotazione salvata:', result.data.bookingId);
                    
                    // Aggiorna cache locale
                    const key = getBookingKey(bookingData.serviceId, bookingData.date, bookingData.time);
                    bookings[key] = (bookings[key] || 0) + 1;
                    
                    return { success: true, bookingId: result.data.bookingId };
                } else {
                    throw new Error(result.message);
                }
            } catch (error) {
                console.error('❌ Errore salvataggio su Google Sheets:', error);
                
                // Genera ID fittizio per continuare il flusso
                const bookingId = 'TEMP-' + Date.now();
                const key = getBookingKey(bookingData.serviceId, bookingData.date, bookingData.time);
                bookings[key] = (bookings[key] || 0) + 1;
                
                return { success: true, bookingId: bookingId };
            }
        }

        // Verifica disponibilità in tempo reale da Google Sheets
        async function checkAvailabilityOnline(serviceId, date, time) {
            try {
                const url = `${GOOGLE_APPS_SCRIPT_URL}?action=checkAvailability&serviceId=${serviceId}&date=${date}&time=${time}`;
                const response = await fetch(url);
                const result = await response.json();
                
                if (result.success) {
                    return result.data;
                } else {
                    throw new Error(result.message);
                }
            } catch (error) {
                console.error('❌ Errore verifica disponibilità online:', error);
                return null;
            }
        }

        // Funzione per selezionare un servizio
        function selectService(serviceId) {
            // Rimuovi selezione precedente
            document.querySelectorAll('.service-card').forEach(card => {
                card.classList.remove('selected');
            });
            
            // Seleziona nuovo servizio
            const selectedCard = document.querySelector(`[data-service-id="${serviceId}"]`);
            selectedCard.classList.add('selected');
            
            selectedService = services.find(s => s.id === serviceId);
            
            // 📊 TRACCIA SELEZIONE SERVIZIO
            trackEvent('Service Selected', {
                service_id: selectedService.id,
                service_name: selectedService.title,
                price: selectedService.price,
                duration: selectedService.duration
            });
            
            // Aggiorna UI
            document.getElementById('selectedServiceName').textContent = selectedService.title;
            document.getElementById('selectedServiceDetails').textContent = `€${selectedService.price} • ${selectedService.duration} minuti`;
            
            document.getElementById('selectedServiceInfo').classList.add('show');
            document.getElementById('noServiceSelected').style.display = 'none';
            document.getElementById('mainBookingForm').style.display = 'grid';
            document.getElementById('mainBookBtn').style.display = 'flex';
            
            // Reset form e disponibilità
            document.getElementById('mainBookingForm').reset();
            document.getElementById('availabilityIndicator').textContent = '';
            document.getElementById('availabilityIndicator').className = 'availability-indicator';
        }

        // Funzione per ottenere la chiave del booking
        function getBookingKey(serviceId, date, time) {
            return `${serviceId}_${date}_${time}`;
        }

        // Funzione per verificare la disponibilità
        async function checkAvailability() {
            if (!selectedService) return null;
            
            const dateInput = document.getElementById('bookingDate');
            const timeInput = document.getElementById('bookingTime');
            
            if (!dateInput.value || !timeInput.value) return null;
            
            // Prima prova il controllo online
            const onlineCheck = await checkAvailabilityOnline(selectedService.id, dateInput.value, timeInput.value);
            if (onlineCheck) {
                return onlineCheck;
            }
            
            // Fallback: controllo locale
            const key = getBookingKey(selectedService.id, dateInput.value, timeInput.value);
            const currentBookings = bookings[key] || 0;
            
            if (currentBookings >= selectedService.maxBookingsPerSlot) {
                return { status: 'unavailable', remaining: 0, available: false };
            } else if (currentBookings >= selectedService.maxBookingsPerSlot - 1) {
                return { status: 'limited', remaining: selectedService.maxBookingsPerSlot - currentBookings, available: true };
            } else {
                return { status: 'available', remaining: selectedService.maxBookingsPerSlot - currentBookings, available: true };
            }
        }

        // Funzione per aggiornare l'indicatore di disponibilità
        async function updateAvailability() {
            const availabilityDiv = document.getElementById('availabilityIndicator');
            const dateInput = document.getElementById('bookingDate');
            
            // Controllo giorni di chiusura (Domenica = 0, Lunedì = 1)
            if (dateInput.value) {
                const selectedDate = new Date(dateInput.value + 'T12:00:00');
                const dayOfWeek = selectedDate.getDay();
                
                if (dayOfWeek === 0 || dayOfWeek === 1) {
                    availabilityDiv.className = 'availability-indicator unavailable';
                    availabilityDiv.textContent = '✗ Il centro è chiuso in questo giorno';
                    alert('Il centro è chiuso di Domenica e Lunedì. Si prega di scegliere un altro giorno.');
                    dateInput.value = '';
                    return;
                }
            }
            
            // Mostra loading
            availabilityDiv.className = 'availability-indicator';
            availabilityDiv.textContent = '🔄 Controllo disponibilità in tempo reale...';
            
            const availability = await checkAvailability();
            
            if (availability) {
                availabilityDiv.className = `availability-indicator ${availability.status}`;
                
                switch (availability.status) {
                    case 'available':
                        availabilityDiv.textContent = `✓ Disponibile (${availability.remaining} posti liberi)`;
                        break;
                    case 'limited':
                        availabilityDiv.textContent = `⚠ Ultimi ${availability.remaining} posti disponibili`;
                        break;
                    case 'unavailable':
                        availabilityDiv.textContent = '✗ Non disponibile per questo orario';
                        break;
                }
            } else {
                availabilityDiv.textContent = '';
                availabilityDiv.className = 'availability-indicator';
            }
        }

        // Funzione per effettuare la prenotazione
        async function bookSelectedService() {
            if (!selectedService) {
                alert('Seleziona prima un trattamento.');
                return;
            }
            
            const nameInput = document.getElementById('customerName');
            const phoneInput = document.getElementById('customerPhone');
            const dateInput = document.getElementById('bookingDate');
            const timeInput = document.getElementById('bookingTime');
            
            if (!dateInput.value || !timeInput.value || !nameInput.value || !phoneInput.value) {
                alert('Per favore, compila tutti i campi per procedere con la prenotazione.');
                return;
            }
            
            // Mostra loading
            const bookBtn = document.getElementById('mainBookBtn');
            const originalText = bookBtn.innerHTML;
            bookBtn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Verifica disponibilità...';
            bookBtn.disabled = true;
            
            const availability = await checkAvailability();
            
            if (!availability || !availability.available) {
                alert('Spiacenti, questo orario non è più disponibile. Seleziona un altro orario.');
                bookBtn.innerHTML = originalText;
                bookBtn.disabled = false;
                return;
            }
            
            // 📊 TRACCIA TENTATIVO DI PRENOTAZIONE
            trackEvent('Booking Attempt', {
                service_id: selectedService.id,
                service_name: selectedService.title,
                price: selectedService.price,
                duration: selectedService.duration,
                customer_name: nameInput.value,
                booking_date: dateInput.value,
                booking_time: timeInput.value,
                availability_status: availability.status
            });
            
            // Salva la prenotazione su Google Sheets
            bookBtn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Salvataggio prenotazione...';
            
            const bookingData = {
                serviceId: selectedService.id,
                serviceName: selectedService.title,
                price: selectedService.price,
                date: dateInput.value,
                time: timeInput.value,
                customerName: nameInput.value,
                customerPhone: phoneInput.value,
                timestamp: new Date().toISOString()
            };
            
            const saveResult = await saveBookingToGoogle(bookingData);
            
            if (!saveResult.success) {
                alert('Errore nel salvataggio della prenotazione. Riprova più tardi.');
                bookBtn.innerHTML = originalText;
                bookBtn.disabled = false;
                return;
            }
            
            // Formatta la data
            const date = new Date(dateInput.value);
            const formattedDate = date.toLocaleDateString('it-IT', { 
                weekday: 'long', 
                year: 'numeric', 
                month: 'long', 
                day: 'numeric' 
            });
            
            // Crea il messaggio WhatsApp
            const message = `🌸 *PRENOTAZIONE CHIARA BEAUTY BOUTIQUE* 🌸

👤 *Nome:* ${nameInput.value}
📱 *Telefono:* ${phoneInput.value}

💆‍♀️ *Trattamento:* ${selectedService.title}
📅 *Data:* ${formattedDate}
🕐 *Orario:* ${timeInput.value}
⏱ *Durata:* ${selectedService.duration} minuti
💰 *Prezzo:* €${selectedService.price}

📍 *Centro Estetico:* Via Roma 133, Nardò (Lecce)
🆔 *Codice Prenotazione:* ${saveResult.bookingId}

Confermo la mia prenotazione per il trattamento selezionato. Grazie! ✨`;
            
            // Apri WhatsApp con il messaggio
            const whatsappUrl = `https://wa.me/${WHATSAPP_NUMBER}?text=${encodeURIComponent(message)}`;
            window.open(whatsappUrl, '_blank');
            
            // 📊 TRACCIA COMPLETAMENTO PRENOTAZIONE
            trackEvent('Booking Completed', {
                service_id: selectedService.id,
                service_name: selectedService.title,
                price: selectedService.price,
                duration: selectedService.duration,
                booking_date: formattedDate,
                booking_time: timeInput.value,
                revenue: selectedService.price,
                booking_id: saveResult.bookingId
            });
            
            // Reset UI
            bookBtn.innerHTML = originalText;
            bookBtn.disabled = false;
            
            // Mostra il popup per la consulenza nutrizionale dopo un breve ritardo
            setTimeout(() => {
                showNutritionistPopup();
            }, 1500);
            
            // Aggiorna la disponibilità
            updateAvailability();
            
            // Reset del form e selezione
            document.getElementById('mainBookingForm').reset();
            document.getElementById('selectedServiceInfo').classList.remove('show');
            document.getElementById('noServiceSelected').style.display = 'block';
            document.getElementById('mainBookingForm').style.display = 'none';
            document.getElementById('mainBookBtn').style.display = 'none';
            
            // Rimuovi selezione servizio
            document.querySelectorAll('.service-card').forEach(card => {
                card.classList.remove('selected');
            });
            selectedService = null;
        }

        // FUNZIONI PER IL POPUP NUTRIZIONISTA
        function showNutritionistPopup() {
            document.getElementById('nutritionistPopup').classList.add('show');
            document.body.style.overflow = 'hidden';
        }

        function closeNutritionistPopup() {
            document.getElementById('nutritionistPopup').classList.remove('show');
            document.body.style.overflow = 'auto';
        }

        function acceptNutritionistOffer(event) {
            event.preventDefault();
            const name = document.getElementById('customerName').value || 'Cliente';

            // 📊 TRACCIA INTERESSE CONSULENZA NUTRIZIONALE
            trackEvent('Nutritionist Interest', {
                customer_name: name,
                source: 'post_booking_popup'
            });

            const message = `Ciao! Sono ${name}, ho appena prenotato un trattamento estetico presso Chiara Beauty Boutique e vorrei approfittare dell'offerta speciale sulla consulenza nutrizionale. Puoi fornirmi maggiori dettagli? Grazie!`;

            const whatsappUrl = `https://wa.me/393665068384?text=${encodeURIComponent(message)}`;

            window.open(whatsappUrl, '_blank');
            closeNutritionistPopup();
        }

        function declineNutritionistOffer() {
            // 📊 TRACCIA RIFIUTO CONSULENZA NUTRIZIONALE
            trackEvent('Nutritionist Declined', {
                source: 'post_booking_popup'
            });
            closeNutritionistPopup();
        }

        // Orari di apertura aggiornati
        function generateTimeSlots() {
            const slots = [];
            // Fascia Mattutina: 09:30 - 13:30
            for (let h = 9; h <= 13; h++) {
                for (let m = 0; m < 60; m += 30) {
                    if (h === 9 && m < 30) continue;
                    if (h === 13 && m > 30) continue;
                    slots.push(`${h.toString().padStart(2, '0')}:${m.toString().padStart(2, '0')}`);
                }
            }
            // Fascia Pomeridiana: 16:00 - 20:00
            for (let h = 16; h <= 20; h++) {
                for (let m = 0; m < 60; m += 30) {
                    if (h === 20 && m > 0) continue;
                     slots.push(`${h.toString().padStart(2, '0')}:${m.toString().padStart(2, '0')}`);
                }
            }
            return slots;
        }

        function getMinDate() {
            return new Date().toISOString().split('T')[0];
        }

        function generateServiceCards() {
            const container = document.getElementById('servicesGrid');
            services.forEach(service => {
                const card = document.createElement('div');
                card.className = 'service-card';
                card.setAttribute('data-service-id', service.id);
                card.onclick = () => selectService(service.id);
                card.innerHTML = `<h3 class="service-title">${service.title}</h3><p class="service-description">${service.description}</p><div class="service-details"><span class="price">€${service.price}</span><span class="duration">${service.duration} minuti</span></div><div class="select-service-text">👆 Clicca per selezionare</div>`;
                container.appendChild(card);
            });
        }

        function populateTimeSlots() {
            const timeSelect = document.getElementById('bookingTime');
            // Svuota le opzioni esistenti prima di ripopolare
            timeSelect.innerHTML = '<option value="">Seleziona orario</option>';
            generateTimeSlots().forEach(time => {
                const option = document.createElement('option');
                option.value = time;
                option.textContent = time;
                timeSelect.appendChild(option);
            });
        }

        // Inizializzazione della pagina
        document.addEventListener('DOMContentLoaded', async function() {
            // Carica prenotazioni da Google Sheets
            await loadBookingsFromGoogle();
            
            generateServiceCards();
            populateTimeSlots();
            document.getElementById('bookingDate').min = getMinDate();
      
            // 📊 TRACCIA VISITA PAGINA PRENOTAZIONI
            trackEvent('Page View', {
                page: 'booking',
                timestamp: new Date().toISOString(),
                existing_bookings: Object.keys(bookings).length
            });
            
            // 📊 TRACCIA CLICK SU LINK ESTERNI
            document.addEventListener('click', function(e) {
                const instagramLink = e.target.closest('a[href*="instagram.com"]');
                if (instagramLink) {
                    trackEvent('External Link Click', {
                        link_type: 'instagram',
                        url: instagramLink.href
                    });
                }
                
                const mapLink = e.target.closest('a[href*="maps.app.goo.gl"]');
                if (mapLink) {
                    trackEvent('External Link Click', {
                        link_type: 'google_maps',
                        url: mapLink.href
                    });
                }
                
                const nutritionistLink = e.target.closest('a[href*="wa.me/393665068384"]');
                if (nutritionistLink) {
                    trackEvent('Nutritionist Contact', {
                        source: 'main_section',
                        contact_method: 'whatsapp'
                    });
                }
            });
        });

    </script>

<script src="script.js"></script>

</body>
</html>
